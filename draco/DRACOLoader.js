import{BufferAttribute}from"three/src/core/BufferAttribute.js";import{BufferGeometry}from"three/src/core/BufferGeometry.js";import{FileLoader}from"three/src/loaders/FileLoader.js";import{Loader}from"three/src/loaders/Loader.js";var DRACOLoader=function(e){Loader.call(this,e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}};DRACOLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:DRACOLoader,setDecoderPath:function(e){return this.decoderPath=e,this},setDecoderConfig:function(e){return this.decoderConfig=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(e,r,t,o){var a=new FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(e=>{var t={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,t).then(r).catch(o)}),t,o)},decodeDracoFile:function(e,r,t,o){var a={attributeIDs:t||this.defaultAttributeIDs,attributeTypes:o||this.defaultAttributeTypes,useUniqueIDs:!!t};this.decodeGeometry(e,a).then(r)},decodeGeometry:function(e,r){for(var t in r.attributeTypes){var o=r.attributeTypes[t];void 0!==o.BYTES_PER_ELEMENT&&(r.attributeTypes[t]=o.name)}var a,s=JSON.stringify(r);if(DRACOLoader.taskCache.has(e)){var i=DRACOLoader.taskCache.get(e);if(i.key===s)return i.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var n=this.workerNextTaskID++,d=e.byteLength,c=this._getWorker(n,d).then((t=>(a=t,new Promise(((t,o)=>{a._callbacks[n]={resolve:t,reject:o},a.postMessage({type:"decode",id:n,taskConfig:r,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return c.catch((()=>!0)).then((()=>{a&&n&&this._releaseTask(a,n)})),DRACOLoader.taskCache.set(e,{key:s,promise:c}),c},_createGeometry:function(e){var r=new BufferGeometry;e.index&&r.setIndex(new BufferAttribute(e.index.array,1));for(var t=0;t<e.attributes.length;t++){var o=e.attributes[t],a=o.name,s=o.array,i=o.itemSize;r.setAttribute(a,new BufferAttribute(s,i))}return r},_loadLibrary:function(e,r){var t=new FileLoader(this.manager);return t.setPath(this.decoderPath),t.setResponseType(r),t.setWithCredentials(this.withCredentials),new Promise(((r,o)=>{t.load(e,r,void 0,o)}))},preload:function(){return this._initDecoder(),this},_initDecoder:function(){if(this.decoderPending)return this.decoderPending;var e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,r=[];return e?r.push(this._loadLibrary("draco_decoder.js","text")):(r.push(this._loadLibrary("draco_wasm_wrapper.js","text")),r.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(r).then((r=>{var t=r[0];e||(this.decoderConfig.wasmBinary=r[1]);var o=DRACOLoader.DRACOWorker.toString(),a=["/* draco decoder */",t,"","/* worker */",o.substring(o.indexOf("{")+1,o.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([a]))})),this.decoderPending},_getWorker:function(e,r){return this._initDecoder().then((()=>{var t;return this.workerPool.length<this.workerLimit?((t=new Worker(this.workerSourceURL))._callbacks={},t._taskCosts={},t._taskLoad=0,t.postMessage({type:"init",decoderConfig:this.decoderConfig}),t.onmessage=function(e){var r=e.data;switch(r.type){case"decode":t._callbacks[r.id].resolve(r);break;case"error":t._callbacks[r.id].reject(r);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+r.type+'"')}},this.workerPool.push(t)):this.workerPool.sort((function(e,r){return e._taskLoad>r._taskLoad?-1:1})),(t=this.workerPool[this.workerPool.length-1])._taskCosts[e]=r,t._taskLoad+=r,t}))},_releaseTask:function(e,r){e._taskLoad-=e._taskCosts[r],delete e._callbacks[r],delete e._taskCosts[r]},debug:function(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))},dispose:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),DRACOLoader.DRACOWorker=function(){var e,r;function t(e,r,t,o,a,s){var i=s.num_components(),n=t.num_points()*i,d=n*a.BYTES_PER_ELEMENT,c=function(e,r){switch(r){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,a),u=e._malloc(d);r.GetAttributeDataArrayForAllPoints(t,s,c,d,u);var h=new a(e.HEAPF32.buffer,u,n).slice();return e._free(u),{name:o,array:h,itemSize:i}}onmessage=function(o){var a=o.data;switch(a.type){case"init":e=a.decoderConfig,r=new Promise((function(r){e.onModuleLoaded=function(e){r({draco:e})},DracoDecoderModule(e)}));break;case"decode":var s=a.buffer,i=a.taskConfig;r.then((e=>{var r=e.draco,o=new r.Decoder,n=new r.DecoderBuffer;n.Init(new Int8Array(s),s.byteLength);try{var d=function(e,r,o,a){var s,i,n=a.attributeIDs,d=a.attributeTypes,c=r.GetEncodedGeometryType(o);if(c===e.TRIANGULAR_MESH)s=new e.Mesh,i=r.DecodeBufferToMesh(o,s);else{if(c!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");s=new e.PointCloud,i=r.DecodeBufferToPointCloud(o,s)}if(!i.ok()||0===s.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+i.error_msg());var u={index:null,attributes:[]};for(var h in n){var f,l,y=self[d[h]];if(a.useUniqueIDs)l=n[h],f=r.GetAttributeByUniqueId(s,l);else{if(-1===(l=r.GetAttributeId(s,e[n[h]])))continue;f=r.GetAttribute(s,l)}u.attributes.push(t(e,r,s,h,y,f))}return c===e.TRIANGULAR_MESH&&(u.index=function(e,r,t){var o=3*t.num_faces(),a=4*o,s=e._malloc(a);r.GetTrianglesUInt32Array(t,a,s);var i=new Uint32Array(e.HEAPF32.buffer,s,o).slice();return e._free(s),{array:i,itemSize:1}}(e,r,s)),e.destroy(s),u}(r,o,n,i),c=d.attributes.map((e=>e.array.buffer));d.index&&c.push(d.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:d},c)}catch(e){console.error(e),self.postMessage({type:"error",id:a.id,error:e.message})}finally{r.destroy(n),r.destroy(o)}}))}}},DRACOLoader.taskCache=new WeakMap,DRACOLoader.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},DRACOLoader.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},DRACOLoader.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},DRACOLoader.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")};export{DRACOLoader};