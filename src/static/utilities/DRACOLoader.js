import{BufferAttribute as D,BufferGeometry as A,FileLoader as _,Loader as b}from"./three.min.js";var l=function(e){b.call(this,e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}};l.prototype=Object.assign(Object.create(b.prototype),{constructor:l,setDecoderPath:function(e){return this.decoderPath=e,this},setDecoderConfig:function(e){return this.decoderConfig=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(e,o,r,i){var s=new _(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,u=>{var t={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(u,t).then(o).catch(i)},r,i)},decodeDracoFile:function(e,o,r,i){var s={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!r};this.decodeGeometry(e,s).then(o)},decodeGeometry:function(e,o){for(var r in o.attributeTypes){var i=o.attributeTypes[r];i.BYTES_PER_ELEMENT!==void 0&&(o.attributeTypes[r]=i.name)}var s=JSON.stringify(o),u;if(l.taskCache.has(e)){var t=l.taskCache.get(e);if(t.key===s)return t.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var n=this.workerNextTaskID++,h=e.byteLength,f=this._getWorker(n,h).then(d=>(u=d,new Promise((c,a)=>{u._callbacks[n]={resolve:c,reject:a},u.postMessage({type:"decode",id:n,taskConfig:o,buffer:e},[e])}))).then(d=>this._createGeometry(d.geometry));return f.catch(()=>!0).then(()=>{u&&n&&this._releaseTask(u,n)}),l.taskCache.set(e,{key:s,promise:f}),f},_createGeometry:function(e){var o=new A;e.index&&o.setIndex(new D(e.index.array,1));for(var r=0;r<e.attributes.length;r++){var i=e.attributes[r],s=i.name,u=i.array,t=i.itemSize;o.setAttribute(s,new D(u,t))}return o},_loadLibrary:function(e,o){var r=new _(this.manager);return r.setPath(this.decoderPath),r.setResponseType(o),r.setWithCredentials(this.withCredentials),new Promise((i,s)=>{r.load(e,i,void 0,s)})},preload:function(){return this._initDecoder(),this},_initDecoder:function(){if(this.decoderPending)return this.decoderPending;var e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",o=[];return e?o.push(this._loadLibrary("draco_decoder.js","text")):(o.push(this._loadLibrary("draco_wasm_wrapper.js","text")),o.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(o).then(r=>{var i=r[0];e||(this.decoderConfig.wasmBinary=r[1]);var s=l.DRACOWorker.toString(),u=["/* draco decoder */",i,"","/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([u]))}),this.decoderPending},_getWorker:function(e,o){return this._initDecoder().then(()=>{var r,r;return this.workerPool.length<this.workerLimit?((r=new Worker(this.workerSourceURL))._callbacks={},r._taskCosts={},r._taskLoad=0,r.postMessage({type:"init",decoderConfig:this.decoderConfig}),r.onmessage=function(i){var s=i.data;switch(s.type){case"decode":r._callbacks[s.id].resolve(s);break;case"error":r._callbacks[s.id].reject(s);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+s.type+'"')}},this.workerPool.push(r)):this.workerPool.sort(function(i,s){return i._taskLoad>s._taskLoad?-1:1}),(r=this.workerPool[this.workerPool.length-1])._taskCosts[e]=o,r._taskLoad+=o,r})},_releaseTask:function(e,o){e._taskLoad-=e._taskCosts[o],delete e._callbacks[o],delete e._taskCosts[o]},debug:function(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))},dispose:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),l.DRACOWorker=function(){var e,o;function r(t,n,h,f){var d=f.attributeIDs,c=f.attributeTypes,a,y,m=n.GetEncodedGeometryType(h);if(m===t.TRIANGULAR_MESH)a=new t.Mesh,y=n.DecodeBufferToMesh(h,a);else{if(m!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");a=new t.PointCloud,y=n.DecodeBufferToPointCloud(h,a)}if(!y.ok()||a.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+y.error_msg());var w={index:null,attributes:[]};for(var p in d){var T=self[c[p]],g,k;if(f.useUniqueIDs)k=d[p],g=n.GetAttributeByUniqueId(a,k);else{if((k=n.GetAttributeId(a,t[d[p]]))===-1)continue;g=n.GetAttribute(a,k)}w.attributes.push(s(t,n,a,p,T,g))}return m===t.TRIANGULAR_MESH&&(w.index=i(t,n,a)),t.destroy(a),w}function i(t,n,h){var f,d=3*h.num_faces(),c=4*d,a=t._malloc(c);n.GetTrianglesUInt32Array(h,c,a);var y=new Uint32Array(t.HEAPF32.buffer,a,d).slice();return t._free(a),{array:y,itemSize:1}}function s(t,n,h,f,d,c){var a=c.num_components(),y,m=h.num_points()*a,w=m*d.BYTES_PER_ELEMENT,p=u(t,d),T=t._malloc(w);n.GetAttributeDataArrayForAllPoints(h,c,p,w,T);var g=new d(t.HEAPF32.buffer,T,m).slice();return t._free(T),{name:f,array:g,itemSize:a}}function u(t,n){switch(n){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}onmessage=function(t){var n=t.data;switch(n.type){case"init":e=n.decoderConfig,o=new Promise(function(d){e.onModuleLoaded=function(c){d({draco:c})},DracoDecoderModule(e)});break;case"decode":var h=n.buffer,f=n.taskConfig;o.then(d=>{var c=d.draco,a=new c.Decoder,y=new c.DecoderBuffer;y.Init(new Int8Array(h),h.byteLength);try{var m=r(c,a,y,f),w=m.attributes.map(p=>p.array.buffer);m.index&&w.push(m.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:m},w)}catch(p){console.error(p),self.postMessage({type:"error",id:n.id,error:p.message})}finally{c.destroy(y),c.destroy(a)}})}}},l.taskCache=new WeakMap,l.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},l.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},l.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},l.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")};export{l as DRACOLoader};
